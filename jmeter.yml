trigger:
- main  # Trigger on main branch push or you can specify your branch

pool:
  name: 'Azure Pipelines'  # Use the default hosted agent pool

jobs:
- job: RunJMeterTests
  displayName: 'Run JMeter Performance Tests on Windows'
  timeoutInMinutes: 120  # Optional: Increase timeout if tests are long-running

  steps:

  # Step 1: Install JMeter on Windows
  - script: |
      echo "Installing JMeter"
      Invoke-WebRequest -Uri "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.4.1.zip" -OutFile "apache-jmeter-5.4.1.zip"
      Expand-Archive -Path "apache-jmeter-5.4.1.zip" -DestinationPath "C:\"
      Move-Item -Path "C:\apache-jmeter-5.4.1" -Destination "C:\jmeter"
    displayName: 'Install JMeter'

  # Step 2: Check out the repository to get the JMeter test plan (.jmx) file
  - checkout: self

  # Step 3: Run JMeter Test Plan with Retry Logic
  - script: |
      echo "Running JMeter Test Plan"
      $maxRetries = 3
      $retryCount = 0
      $success = $false
      while (-not $success -and $retryCount -lt $maxRetries) {
        $retryCount++
        echo "Attempt $retryCount of $maxRetries"
        try {
          C:\jmeter\bin\jmeter -n -t $(Build.SourcesDirectory)\tests\test-plan.jmx -l $(Build.ArtifactStagingDirectory)\results.jtl -Dlog_level.jmeter=DEBUG
          $success = $true
        } catch {
          echo "JMeter test failed on attempt $retryCount"
          if ($retryCount -eq $maxRetries) {
            throw "JMeter test failed after $maxRetries attempts."
          }
          echo "Retrying in 30 seconds..."
          Start-Sleep -Seconds 30
        }
      }
    displayName: 'Run JMeter Test Plan (With Retries)'

  # Step 4: Publish JMeter results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '$(Build.ArtifactStagingDirectory)\results.jtl'
      testRunTitle: 'JMeter Test Results'
    displayName: 'Publish JMeter Results'

  # Optional: Step 5: Archive JMeter Logs and Results
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'jmeter-results'
      publishLocation: 'Container'
    displayName: 'Archive JMeter Results'
